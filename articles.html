<script>
  const posts = ['first.md', 'second.md', 'third.md']; // adapte ici
  const baseURL = 'https://hacqueen-fr.github.io/posts/';
  const allArticles = [];

  async function loadArticles() {
    const tagSet = new Set();
    for (const file of posts) {
      const res = await fetch(baseURL + file);
      const text = await res.text();

      let content = text;
      if (text.startsWith('---')) {
        const parts = text.split('---');
        content = parts.slice(2).join('---').trim();
      }

      const title = text.match(/title:\s*(.*)/)?.[1]?.trim() || file;
      const date = text.match(/date:\s*(.*)/)?.[1]?.trim() || '';
      const description = text.match(/description:\s*(.*)/)?.[1]?.trim() || 'No description.';
      const tagsRaw = text.match(/tags:\s*\[(.*?)\]/)?.[1] || '';
      const tags = tagsRaw.split(',').map(t => t.trim().replace(/['"]/g, '')).filter(Boolean);

      tags.forEach(tag => tagSet.add(tag));

      allArticles.push({ file, title, date, description, tags, content });
    }

    updateTagFilter([...tagSet]);
    displayArticles(allArticles);
  }

  function updateTagFilter(tags) {
    const select = document.getElementById('tagFilter');
    tags.sort().forEach(tag => {
      const option = document.createElement('option');
      option.value = tag;
      option.textContent = tag;
      select.appendChild(option);
    });
  }

  function displayArticles(articles) {
    const container = document.getElementById('articles');
    container.innerHTML = '';

    articles.forEach(article => {
      const card = document.createElement('div');
      card.className = 'article-card';
      card.innerHTML = `
        <h2>${article.title}</h2>
        <p><em>${article.date}</em></p>
        <p>${article.description}</p>
        <div class="tags">${article.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ')}</div>
        <button class="button" onclick="displayArticle('${article.file}', '${article.title}')">ðŸ“– Read</button>
      `;
      container.appendChild(card);
    });
  }

  async function displayArticle(file, titleFromButton = null) {
    const res = await fetch(baseURL + file);
    const raw = await res.text();

    let content = raw;
    if (raw.startsWith('---')) {
      const parts = raw.split('---');
      content = parts.slice(2).join('---').trim();
    }

    const html = marked.parse(content);
    const reader = document.getElementById('reader');
    reader.innerHTML = html;

    // Mascotte et bulle
    const mascot = document.getElementById('mascot');
    const bubble = document.getElementById('bubble');
    mascot.classList.add('active');
    bubble.classList.add('show');
    setTimeout(() => {
      mascot.classList.remove('active');
      bubble.classList.remove('show');
    }, 1800);

    // ðŸ”¥ Change le titre de la page
    if (titleFromButton) {
      document.title = `ðŸ“– ${titleFromButton} â€” Hacqueen`;
    }

    reader.scrollIntoView({ behavior: 'smooth' });
  }

  // Recherche live
  document.getElementById('search').addEventListener('input', e => {
    const value = e.target.value.toLowerCase();
    const filtered = allArticles.filter(a =>
      a.title.toLowerCase().includes(value) ||
      a.description.toLowerCase().includes(value) ||
      a.tags.some(tag => tag.toLowerCase().includes(value))
    );
    displayArticles(filtered);
  });

  // Tri par tag
  document.getElementById('tagFilter').addEventListener('change', e => {
    const tag = e.target.value;
    const filtered = tag ? allArticles.filter(a => a.tags.includes(tag)) : allArticles;
    displayArticles(filtered);
  });

  // ðŸŒŸ Lance tout
  async function start() {
    await loadArticles();

    const urlParams = new URLSearchParams(window.location.search);
    const fileId = urlParams.get('id');
    const tagFilter = urlParams.get('tag');

    if (fileId) {
      document.getElementById('articles').style.display = 'none';
      document.querySelector('.search-bar')?.remove();
      const article = allArticles.find(a => a.file === fileId);
      displayArticle(fileId, article?.title || fileId);
    } else if (tagFilter) {
      const filtered = allArticles.filter(a => a.tags.includes(tagFilter));
      document.getElementById('tagFilter').value = tagFilter;
      displayArticles(filtered);
    }
  }

  start();
</script>
